import dotenv from 'dotenv';
dotenv.config();
import express from 'express';
import cors from 'cors';
import path from 'path';
import { fileURLToPath } from 'url';
import bookingRoutes from './routes/booking.js';
import authRoutes from './routes/auth.js';
import connectDB from './db.js';

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
connectDB();

console.log(`ðŸŸ¢ Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ð¹ SECRET_KEY: ${process.env.JWT_SECRET}`);


const app = express();
const PORT = process.env.PORT || 8080;

// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Middleware Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ JSON Ð¸ CORS
app.use(express.json());
app.use(cors()); // Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ ÑÐ¾ Ð²ÑÐµÑ… Ð´Ð¾Ð¼ÐµÐ½Ð¾Ð²

// Ð£ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ public Ð´Ð»Ñ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
const publicDir = path.join(__dirname, 'public');
app.use(express.static(publicDir));

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ð´Ð»Ñ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
app.use('/booking', bookingRoutes);

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
app.use('/auth', authRoutes);

// Ð“Ð»Ð°Ð²Ð½Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð°
app.get('/', (req, res) => {
    res.sendFile(path.join(publicDir, 'home.html'));
});

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ð´Ð»Ñ HTML-ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ð±ÐµÐ· .html
app.get('/:page', (req, res, next) => {
    const { page } = req.params;
    const filePath = path.join(publicDir, `${page}.html`);
    res.sendFile(filePath, (err) => {
        if (err) {
            next(); // ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ Ð´Ð°Ð»ÑŒÑˆÐµ, ÐµÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½
        }
    });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
app.listen(PORT, () => {
    console.log(`Server running on http://localhost:${PORT}`);
});
